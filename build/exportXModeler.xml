<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project default="exportProject" basedir=".">
	<description>
	This script first executes buildXMF. Afterwards AutoMLM is copied to the project folder.
	All needes files are packed into a Zip-Archive which can be provided to an end user.
	</description>
	<property file="build.properties"/>
	<target name="exportProject" depends="init 	, compile, packProject">
		<antcall target="zip"/>
		<antcall target="makeSetupExe"/>
	</target>
	<target name="makeSetupExe">
		<property name="makeScriptPath" value="./startSetupScript.ps1"/>
		<!-- Defined in build.properties -->
		<property name="innoSetupPath" value="${path_to_innosetup}"/>
		<!-- Call PowerShell script -->
		<exec executable="powershell" failonerror="true">
			<arg value="-File"/>
			<arg value="${makeScriptPath}"/>
			<arg value="${innoSetupPath}"/>
		</exec>
	</target>
	<target name="zip">
		<zip destfile="${outputArchive}" compress="yes" duplicate="fail">
			<zipfileset dir="${outputDirectory}"/>
		</zip>
	</target>
	<target name="compile">
		<ant antfile="buildXMF.xml"/>
	</target>
	<target name="packProject">
		<ant antfile="packProject.xml"/>
	</target>
	<target name="archiveOldExportVersion">
		<move todir="${archiveDir}" overwrite="true">
			<fileset dir="${output}">
				<include name="*.zip"/>
			</fileset>
		</move>
	</target>
	<target name="init">
		<property name="loadedVersion" value="${version}"/>
		<property name="loadedBuildDate" value="${builddate}"/>
		<property name="output" location="output/"/>
		<property name="archiveDir" location="${output}/archiv/"/>
		<condition property="version" value="${loadedVersion}-SNAPSHOT" else="${loadedVersion}">
			<or>
				<resourceexists>
					<file file="${output}/XModeler-${loadedVersion}.zip"/>
				</resourceexists>
				<resourceexists>
					<file file="${archiveDir}/XModeler-${loadedVersion}.zip"/>
				</resourceexists>
			</or>
		</condition>
		<property name="outputDirectory" location="${output}/XModeler-${version}"/>
		<property name="outputArchive" location="${output}/XModeler-${version}.zip"/>
		<property name="prefix" value="XModeler/"/>
	</target>
</project>
